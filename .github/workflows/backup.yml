# ===========================================
# MeauxOS D1 Database Backup
# ===========================================
# Runs daily to backup D1 to R2

name: Database Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    name: Backup D1 to R2
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create Backup
        run: |
          BACKUP_DATE=$(date -u +"%Y-%m-%d_%H-%M-%S")
          
          echo "ðŸ“¦ Creating D1 backup..."
          
          # Get all tables
          TABLES=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/d1/database/${{ secrets.D1_DATABASE_ID }}/query" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"sql": "SELECT name FROM sqlite_master WHERE type=\"table\" AND name NOT LIKE \"sqlite_%\" AND name NOT LIKE \"_cf%\";"}' | jq -r '.result[0].results[].name')
          
          # Create backup JSON
          echo "{\"backup_date\": \"$BACKUP_DATE\", \"tables\": {" > backup.json
          
          FIRST=true
          for TABLE in $TABLES; do
            DATA=$(curl -s "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/d1/database/${{ secrets.D1_DATABASE_ID }}/query" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"sql\": \"SELECT * FROM $TABLE;\"}" | jq -c '.result[0].results // []')
            
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              echo "," >> backup.json
            fi
            echo "\"$TABLE\": $DATA" >> backup.json
          done
          
          echo "}}" >> backup.json
          
          # Upload to R2
          echo "ðŸ“¤ Uploading to R2..."
          curl -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/r2/buckets/allinfrastructure/objects/backups/d1-scheduled-$BACKUP_DATE.json" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data-binary "@backup.json"
          
          echo "âœ… Backup complete: backups/d1-scheduled-$BACKUP_DATE.json"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
