# ===========================================
# MeauxOS Ecosystem Deploy Pipeline
# ===========================================
# Deploys to Cloudflare on push to main

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '18'

jobs:
  # ===========================================
  # Deploy Workers
  # ===========================================
  deploy-workers:
    name: Deploy Workers
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy to Cloudflare
        run: |
          # Deploy each worker in apps/workers/
          if [ -d "apps/workers" ]; then
            for worker in apps/workers/*/; do
              if [ -f "$worker/wrangler.toml" ]; then
                echo "Deploying $worker..."
                cd "$worker"
                wrangler deploy
                cd -
              fi
            done
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # ===========================================
  # Deploy Pages
  # ===========================================
  deploy-pages:
    name: Deploy Pages
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build --if-present

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ecosystem
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================
  # Notify
  # ===========================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-workers, deploy-pages]
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy-workers.result }}" == "success" ] && [ "${{ needs.deploy-pages.result }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment had issues"
            exit 1
          fi
